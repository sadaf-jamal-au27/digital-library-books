# Build, push Docker images, and deploy to Kubernetes on push to main/master or version tag
name: Build, Push and Deploy to K8s

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'

env:
  BACKEND_IMAGE: sadafjamal3/digital-library-backend
  FRONTEND_IMAGE: sadafjamal3/digital-library-frontend
  K8S_NAMESPACE: digital-library

jobs:
  test:
    name: Run tests before build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install root deps
        run: npm ci
      - name: Install server deps
        working-directory: server
        run: npm ci
      - name: Install client deps
        working-directory: client
        run: npm ci
      - name: Run server tests
        working-directory: server
        run: npm test
      - name: Run client tests
        working-directory: client
        run: npm test

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker image tags
        id: tags
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            echo "backend_tags=${{ env.BACKEND_IMAGE }}:latest,${{ env.BACKEND_IMAGE }}:${VERSION}" >> $GITHUB_OUTPUT
            echo "frontend_tags=${{ env.FRONTEND_IMAGE }}:latest,${{ env.FRONTEND_IMAGE }}:${VERSION}" >> $GITHUB_OUTPUT
          else
            echo "backend_tags=${{ env.BACKEND_IMAGE }}:latest,${{ env.BACKEND_IMAGE }}:${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "frontend_tags=${{ env.FRONTEND_IMAGE }}:latest,${{ env.FRONTEND_IMAGE }}:${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Build and push backend
        uses: docker/build-push-action@v6
        with:
          context: ./server
          file: ./server/Dockerfile
          push: true
          tags: ${{ steps.tags.outputs.backend_tags }}
          cache-from: type=gha
          cache-to: type=gha

      - name: Build and push frontend
        uses: docker/build-push-action@v6
        with:
          context: ./client
          file: ./client/Dockerfile
          push: true
          tags: ${{ steps.tags.outputs.frontend_tags }}
          cache-from: type=gha
          cache-to: type=gha

  deploy:
    name: Update Git for Argo CD
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v'))
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image tag
        id: tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Update image tag in overlay for Argo CD
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          sed -i "s/newTag: .*/newTag: ${TAG}/g" k8s/overlays/dev/kustomization.yaml
          cat k8s/overlays/dev/kustomization.yaml

      - name: Commit and push (Argo CD will sync)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add k8s/overlays/dev/kustomization.yaml
          git diff --staged --quiet || git commit -m "chore: deploy image ${{ steps.tag.outputs.tag }} [skip ci]"
          git push
